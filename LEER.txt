1.2 Crear Connector en EMQX Dashboard
URL Dashboard: http://localhost:18083

Credenciales:

Usuario: admin
Password: public
Navegaci√≥n:

Click en Integration (men√∫ izquierdo)
Click en Connectors
Click en + Create Connector
Buscar y seleccionar MongoDB

1.3 Configuraci√≥n del Connector
Formulario completo:

Campo	                    Valor
Connector Name	           mongodb_smartcampus
MongoDB Type	           rs (Replica Set)
Server List	               mongo-primary:27017,mongo-secondary1:27017,mongo-secondary2:27017
Replica Set Name	       rs0
Database	               smartcampus
Write Concern              w1
Read Mode	               master
Auth Source                (vac√≠o)
Username	                (vac√≠o)
Password	                (vac√≠o)
Use Legacy Protocol	       false
SSL/TLS	                    Disabled
Pool Size	                8
Bot√≥n:                      Click en Test Connection

# Resultado esperado:

‚úÖ Connection successful
Connected to: mongo-primary:27017
Replica Set: rs0
Database: smartcampus

Bot√≥n: Click en Create

###########################################3

1.4 Verificar en Dashboard
Navegaci√≥n:

Integration ‚Üí Connectors
Buscar mongodb_smartcampus
Estado debe ser: Connected (verde)

2. LAS 14 REGLAS PASO A PASO
üéØ Arquitectura de Validaci√≥n
universidad/aulas/solicitud (topic inicial)
    ‚Üì
[REGLA 1A] Horario 06:00-23:00 ‚úì ‚Üí paso2
[REGLA 1B] Horario inv√°lido ‚úó ‚Üí errores/horario-invalido
    ‚Üì
[REGLA 2] Rol Profesor (JWT) ‚Üí paso3
    ‚Üì
[REGLA 3A] Duraci√≥n 45-240min ‚úì ‚Üí paso4
[REGLA 3B] Duraci√≥n inv√°lida ‚úó ‚Üí errores/duracion-invalida
    ‚Üì
[REGLA 4A] Cupo v√°lido ‚úì ‚Üí paso5
[REGLA 4B] Cupo excedido ‚úó ‚Üí errores/cupo-excedido
    ‚Üì
[REGLA 5A] Consultar Aula MongoDB ‚Üí paso5-resultado
[REGLA 5B] Aula encontrada ‚úì ‚Üí paso6
[REGLA 5C] Aula no disponible ‚úó ‚Üí errores/aula-no-disponible
    ‚Üì
[REGLA 6A] Consultar Profesor MongoDB ‚Üí paso6-resultado
[REGLA 6B] Profesor autorizado ‚úì ‚Üí validacion/aprobada
[REGLA 6C] Profesor no autorizado ‚úó ‚Üí errores/profesor-no-autorizado
    ‚Üì
[REGLA 7] Persistir en MongoDB ‚Üí cronograma-creado

#############################################33
REGLA 1A: HORARIO V√ÅLIDO
Dashboard EMQX:

Integration ‚Üí Rules
+ Create
Configuraci√≥n:
Campo	        Valor
Name	        regla_01_horario_valido
Note	        Valida que el horario est√© entre 06:00 y 23:00
Enable	        true

sql:
SELECT
  payload.id_aula as id_aula,
  payload.id_profesor as id_profesor,
  payload.id_materia as id_materia,
  payload.id_carrera as id_carrera,
  payload.fecha as fecha,
  payload.hora_inicio as hora_inicio,
  payload.hora_fin as hora_fin,
  payload.duracion_minutos as duracion_minutos,
  payload.cupo_actual as cupo_actual,
  payload.cupo_maximo as cupo_maximo,
  payload.tipo as tipo,
  payload
FROM
  "universidad/aulas/solicitud"
WHERE
  payload.hora_inicio >= '06:00'
  AND 
  payload.hora_inicio < '23:00'
  AND
  payload.hora_fin <= '23:00'

-Actions:

Click + Add Action
Seleccionar Message Republish
Configurar:
Campo       	Valor
Topic       	universidad/aulas/validacion/paso2
QoS	            1
Retain	        false
Payload	        ${payload}

Click Create

#############################################3
REGLA 1B: HORARIO INV√ÅLIDO
Configuraci√≥n:

Campo	Valor
Name	regla_01_horario_invalido
Note	Rechaza mensajes fuera del horario permitido

SQL:
SELECT
  payload.hora_inicio as hora_inicio,
  payload.hora_fin as hora_fin,
  payload.id_profesor as id_profesor,
  payload
FROM
  "universidad/aulas/solicitud"
WHERE
  payload.hora_inicio < '06:00'
  OR
  payload.hora_inicio >= '23:00'
  OR
  payload.hora_fin > '23:00'

-Action: Message Republish

Campo	    Valor
Topic	    universidad/errores/horario-invalido
QoS	        1
Payload  Template:
                {
                "error": "horario_invalido",
                "mensaje": "El horario debe estar entre 06:00 y 23:00",
                "hora_inicio": "${hora_inicio}",
                "hora_fin": "${hora_fin}",
                "id_profesor": "${id_profesor}",
                "timestamp": "${timestamp}",
                "regla": "regla_01_horario_invalido"
                }

##############################################
REGLA 2: ROL PROFESOR (Paso directo)
Nota: La validaci√≥n de rol se hace en JWT. Esta regla solo pasa el mensaje.

Configuraci√≥n:

Campo	Valor
Name	regla_02_paso_rol
Note	Pasa al siguiente paso (rol validado en JWT)
SQL:

SELECT payload
FROM "universidad/aulas/validacion/paso2"

-Action: Message Republish

Campo	Valor
Topic	universidad/aulas/validacion/paso3
Payload	${payload}

##############################################
REGLA 3A: DURACI√ìN V√ÅLIDA
Campo	Valor
Name	regla_03_duracion_valida
Note	Valida duraci√≥n entre 45 y 240 minutos
SQL:
SELECT
  payload.duracion_minutos as duracion,
  payload
FROM
  "universidad/aulas/validacion/paso3"
WHERE
  payload.duracion_minutos >= 45
  AND
  payload.duracion_minutos <= 240

  Action: Message Republish ‚Üí universidad/aulas/validacion/paso4

  ##############################################

REGLA 3B: DURACI√ìN INV√ÅLIDA
SQL:

SELECT
  payload.duracion_minutos as duracion,
  payload.id_profesor as id_profesor,
  payload
FROM
  "universidad/aulas/validacion/paso3"
WHERE
  payload.duracion_minutos < 45
  OR
  payload.duracion_minutos > 240

-Action: Message Republish ‚Üí universidad/errores/duracion-invalida

Payload Template:
                {
                "error": "duracion_invalida",
                "mensaje": "La duraci√≥n debe estar entre 45 y 240 minutos",
                "duracion_minutos": ${duracion},
                "id_profesor": "${id_profesor}",
                "timestamp": "${timestamp}"
                }

##############################################

REGLA 4A: CUPO V√ÅLIDO
SQL:

CopySELECT
  payload.cupo_actual as cupo_actual,
  payload.cupo_maximo as cupo_maximo,
  payload
FROM
  "universidad/aulas/validacion/paso4"
WHERE
  payload.cupo_actual <= payload.cupo_maximo

-Action: Message Republish ‚Üí universidad/aulas/validacion/paso5

###############################################

REGLA 4B: CUPO EXCEDIDO
SQL:

SELECT
  payload.cupo_actual as cupo_actual,
  payload.cupo_maximo as cupo_maximo,
  payload.id_profesor as id_profesor,
  payload
FROM
  "universidad/aulas/validacion/paso4"
WHERE
  payload.cupo_actual > payload.cupo_maximo

-Action: Message Republish ‚Üí universidad/errores/cupo-excedido

##############################################

REGLA 5A: CONSULTAR AULA (MongoDB Find)
‚ö†Ô∏è IMPORTANTE: Esta regla tiene 3 partes (5A, 5B, 5C)

SQL:

SELECT
  payload.id_aula as id_aula,
  payload as payload_original
FROM
  "universidad/aulas/validacion/paso5"
Action: MongoDB Find

1-Click + Add Action
2-Buscar MongoDB
3-Seleccionar Find
4-Configurar:

Campo	    Valor
Connector	mongodb_smartcampus
Collection	aulas
Filter:
        {
        "_id": {"$oid": "${id_aula}"},
        "estado": "disponible"
        }

Response Handling:

Campo	            Valor
Response Action	    Republish
Response Topic	    universidad/aulas/validacion/paso5-resultado
Response Payload Template:
                    {
                    "query_result": ${.},
                    "payload_original": ${payload_original}
                    }

##########################################

REGLA 5B: AULA ENCONTRADA
SQL:

SELECT
  payload.payload_original as datos_originales,
  payload.query_result as resultado_aula
FROM
  "universidad/aulas/validacion/paso5-resultado"
WHERE
  array_length(payload.query_result) > 0

--> Explicaci√≥n: array_length(...) > 0 significa que MongoDB encontr√≥ documentos.

Action: Message Republish ‚Üí universidad/aulas/validacion/paso6

Payload: ${datos_originales}

##########################################

REGLA 5C: AULA NO DISPONIBLE
SQL:

SELECT
  payload.payload_original as datos_originales,
  payload.query_result as resultado_aula
FROM
  "universidad/aulas/validacion/paso5-resultado"
WHERE
  array_length(payload.query_result) = 0

-Action: Message Republish ‚Üí universidad/errores/aula-no-disponible

Payload Template:
                {
                "error": "aula_no_disponible",
                "mensaje": "El aula no existe o no est√° disponible",
                "id_aula": "${datos_originales.id_aula}",
                "id_profesor": "${datos_originales.id_profesor}",
                "timestamp": "${timestamp}"
                }

#########################################
REGLA 6A: CONSULTAR PROFESOR (MongoDB Find)
SQL:

SELECT
  payload.id_profesor as id_profesor,
  payload.id_materia as id_materia,
  payload.id_carrera as id_carrera,
  payload as payload_original
FROM
  "universidad/aulas/validacion/paso6"

-Action: MongoDB Find
Campo	    Valor
Collection	profesor_carrera_materia

Filter:
        {
        "id_profesor": {"$oid": "${id_profesor}"},
        "id_materia": {"$oid": "${id_materia}"},
        "carrera": "${id_carrera}",
        "activa": true
        }

Response Topic: universidad/aulas/validacion/paso6-resultado

##########################################
REGLA 6B: PROFESOR AUTORIZADO
SQL:

SELECT
  payload.payload_original as datos_originales
FROM
  "universidad/aulas/validacion/paso6-resultado"
WHERE
  array_length(payload.query_result) > 0

-Action: Message Republish ‚Üí universidad/aulas/validacion/aprobada

##########################################
REGLA 6C: PROFESOR NO AUTORIZADO
SQL:

SELECT
  payload.payload_original as datos_originales
FROM
  "universidad/aulas/validacion/paso6-resultado"
WHERE
  array_length(payload.query_result) = 0

-Action: Message Republish ‚Üí universidad/errores/profesor-no-autorizado

##########################################
REGLA 7: PERSISTIR CRONOGRAMA (MongoDB Insert)
‚ö†Ô∏è REGLA FINAL

SQL:

SELECT payload FROM "universidad/aulas/validacion/aprobada"

Action: MongoDB Insert One

Campo	      Valor
Collection	  cronograma
Document:
        {
        "id_aula": {"$oid": "${payload.id_aula}"},
        "id_profesor": {"$oid": "${payload.id_profesor}"},
        "id_materia": {"$oid": "${payload.id_materia}"},
        "id_carrera": "${payload.id_carrera}",
        "fecha": "${payload.fecha}",
        "hora_inicio": "${payload.hora_inicio}",
        "hora_fin": "${payload.hora_fin}",
        "duracion_minutos": ${payload.duracion_minutos},
        "cupo_actual": ${payload.cupo_actual},
        "estado": "activo",
        "tipo": "${payload.tipo}",
        "created_at": {"$date": "${timestamp}"}
        }

Response Topic (opcional): universidad/aulas/cronograma-creado

Todas deben tener Status: Enabled (verde)

###########################################
                    JWT
###########################################

3. CONFIGURACI√ìN DE AUTENTICACI√ìN JWT
3.1 Crear Autenticador JWT
Dashboard EMQX:

1-Access Control ‚Üí Authentication
2- + Create

Configuraci√≥n:
Campo	                    Valor
Mechanism	                Password-Based
Backend	                    JWT
JWT From	                password
Algorithm	                hmac-based
Secret	                    bedelia_secret_key
Secret Base64 Encoded	    false
Verify Claims           	{} (vac√≠o)
Enable	                    true

Bot√≥n: Click Create

########################################

3.2 Verificar JWT en Dashboard
Navegaci√≥n:

Access Control ‚Üí Authentication
Buscar jwt
Estado debe ser: Enabled (verde)

#####################################
3.3 Generar JWT desde Consola
Comando:

docker exec -it app_bedelia python -c "
import sys
sys.path.insert(0, '/app')
from utils.jwt_helper import JWTHelper
token = JWTHelper.generar_token({
    'usuario': 'prof_test',
    'rol': 'profesor',
    'id_usuario': '69782822e3bbc9e3e6663728'
})
print(token)
"
Copiar el token generado (ser√° algo como: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...)

###############################################3

4. PRUEBAS DESDE NAVEGADOR Y CONSOLA
4.1 Preparar Datos en MongoDB
Comando consola:
docker exec -it mongo-primary mongosh --eval "
use smartcampus;

// Configurar aula disponible
db.aulas.updateOne(
  {_id: ObjectId('69782821e3bbc9e3e6663726')},
  {\$set: {estado: 'disponible', cupo: 40}}
);

// Configurar asignaci√≥n profesor-materia
db.profesor_carrera_materia.updateOne(
  {
    id_profesor: ObjectId('69782822e3bbc9e3e6663728'),
    id_materia: ObjectId('69782c1728e4a86d0566693e')
  },
  {\$set: {
    carrera: 'Ingenier√≠a en Sistemas',
    activa: true,
    fecha_asignacion: new Date()
  }},
  {upsert: true}
);

print('Datos preparados correctamente');
"

#######################################
4.2 Prueba desde MQTT Explorer (Navegador/Aplicaci√≥n)
Descargar: http://mqtt-explorer.com/

Configurar conexi√≥n:
Campo	                Valor
Protocol	            mqtt://
Host	                localhost
Port	                1883
Username	            (pegar el JWT generado)
Password	            (dejar vac√≠o)
Bot√≥n: Click Connect

#####################################3
Publicar mensaje de prueba:

Topic: universidad/aulas/solicitud
QoS: 1
Payload:
{
  "id_aula": "69782821e3bbc9e3e6663726",
  "id_profesor": "69782822e3bbc9e3e6663728",
  "id_materia": "69782c1728e4a86d0566693e",
  "id_carrera": "Ingenier√≠a en Sistemas",
  "fecha": "2026-01-28",
  "hora_inicio": "14:00",
  "hora_fin": "16:00",
  "duracion_minutos": 120,
  "cupo_actual": 10,
  "cupo_maximo": 40,
  "tipo": "teorica"
}

Click Publish
############################################################
Suscribirse para ver resultados:

Click en + Add subscription
Topic: universidad/aulas/validacion/#
Click en + Add subscription (otra vez)
Topic: universidad/errores/#
Click en + Add subscription (tercera vez)
Topic: universidad/aulas/cronograma-creado
Deber√≠as ver mensajes llegando en cada paso de validaci√≥n.

##############################################
4.3 Prueba desde Consola (mosquitto_pub/sub)
Terminal 1: Suscribirse a resultados
mosquitto_sub -h localhost -p 1883 -t "universidad/aulas/validacion/#" -v

Terminal 2: Suscribirse a errores

mosquitto_sub -h localhost -p 1883 -t "universidad/errores/#" -v

Terminal 3: Publicar mensaje
# Primero generar JWT
JWT=$(docker exec -it app_bedelia python -c "
import sys; sys.path.insert(0, '/app')
from utils.jwt_helper import JWTHelper
print(JWTHelper.generar_token({'usuario': 'test', 'rol': 'profesor'}))
" | tr -d '\r\n')

# Publicar
mosquitto_pub \
  -h localhost \
  -p 1883 \
  -t "universidad/aulas/solicitud" \
  -u "$JWT" \
  -P "" \
  -q 1 \
  -m '{
    "id_aula": "69782821e3bbc9e3e6663726",
    "id_profesor": "69782822e3bbc9e3e6663728",
    "id_materia": "69782c1728e4a86d0566693e",
    "id_carrera": "Ingenier√≠a en Sistemas",
    "fecha": "2026-01-28",
    "hora_inicio": "14:00",
    "hora_fin": "16:00",
    "duracion_minutos": 120,
    "cupo_actual": 10,
    "cupo_maximo": 40,
    "tipo": "teorica"
  }'

##########################################
4.4 Verificar Resultado en MongoDB
Comando consola:
docker exec -it mongo-primary mongosh --eval "
use smartcampus;
db.cronograma.findOne(
  {
    id_aula: ObjectId('69782821e3bbc9e3e6663726'),
    fecha: '2026-01-28'
  },
  {
    _id: 1,
    estado: 1,
    hora_inicio: 1,
    hora_fin: 1,
    cupo_actual: 1
  }
);
"

Salida esperada:
{
  "_id": ObjectId("..."),
  "estado": "activo",
  "hora_inicio": "14:00",
  "hora_fin": "16:00",
  "cupo_actual": 10
}

########################################
4.5 Ver M√©tricas en Dashboard EMQX
Navegador: http://localhost:18083

Navegaci√≥n:

1-Data Integration ‚Üí Rules
2-Click en cualquier regla (ej: regla_01_horario_valido)
3-Ver secci√≥n Metrics:
            Matched: Mensajes evaluados
            Passed: Mensajes que pasaron el WHERE
            Failed: Mensajes con error
            Actions Success: Operaciones exitosas

######################################################
4.6 Ver M√©tricas v√≠a API REST
Navegador: Abrir Developer Tools (F12) ‚Üí Console

JavaScript:
// Autenticaci√≥n
const auth = btoa('admin:public');

// Obtener todas las reglas con m√©tricas
fetch('http://localhost:18083/api/v5/rules', {
  headers: {
    'Authorization': 'Basic ' + auth,
    'Content-Type': 'application/json'
  }
})
.then(r => r.json())
.then(data => {
  console.table(data.data.map(rule => ({
    Nombre: rule.name,
    Estado: rule.enable ? 'Enabled' : 'Disabled',
    Matched: rule.metrics?.matched || 0,
    Passed: rule.metrics?.passed || 0,
    Failed: rule.metrics?.failed || 0
  })));
});
Resultado: Tabla con m√©tricas de todas las reglas.

#############################################
4.7 Prometheus Metrics (si est√° configurado)
Navegador: http://localhost:9090 (Prometheus UI)

Query examples:

# M√©tricas de EMQX
emqx_messages_received_total

# M√©tricas de Rules Engine
emqx_rule_matched_total{rule_id="regla_01_horario_valido"}

# M√©tricas de MongoDB connector
emqx_bridge_mongodb_success_total

###########################################
.8 Pruebas de Rechazo
Test 1: Horario inv√°lido (05:00)
{
  "hora_inicio": "05:00",
  "hora_fin": "07:00",
  "duracion_minutos": 120,
  "cupo_actual": 10,
  "cupo_maximo": 40
}

Resultado esperado: Mensaje en universidad/errores/horario-invalido

#########################################3
Test 2: Duraci√≥n inv√°lida (30 min)
{
  "hora_inicio": "14:00",
  "hora_fin": "14:30",
  "duracion_minutos": 30,
  "cupo_actual": 10,
  "cupo_maximo": 40
}
Resultado esperado: Mensaje en universidad/errores/duracion-invalida

########################################
Test 3: Cupo excedido
{
  "hora_inicio": "14:00",
  "hora_fin": "16:00",
  "duracion_minutos": 120,
  "cupo_actual": 50,
  "cupo_maximo": 40
}

Resultado esperado: Mensaje en universidad/errores/cupo-excedido

########################################3
5. BACKUP Y RESTAURACI√ìN
5.1 Persistencia con Volumen Docker
Editar docker-compose.yml:

Agregar en la secci√≥n emqx:
volumes:
  - emqx_data:/opt/emqx/data

  Agregar al final del archivo:

volumes:
    emqx_data:
    driver: local

Aplicar:
docker-compose down
docker-compose up -d
##########################################################3
Ahora la configuraci√≥n persiste permanentemente ‚úÖ

5.2 Backup Manual (Consola)
Backup:

# Crear directorio
mkdir -p backups/emqx

# Copiar configuraci√≥n
docker cp emqx:/opt/emqx/data/configs/cluster.hocon backups/emqx/

# Backup con timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
tar -czf backups/emqx_backup_$TIMESTAMP.tar.gz backups/emqx/

echo "Backup creado: backups/emqx_backup_$TIMESTAMP.tar.gz"

Restaurar:
# Extraer backup
tar -xzf backups/emqx_backup_20260128_153045.tar.gz

# Copiar al contenedor
docker cp backups/emqx/cluster.hocon emqx:/opt/emqx/data/configs/

# Reiniciar
docker-compose restart emqx

############################################333
5.3 Export v√≠a API REST (Navegador)
Abrir Developer Tools (F12) ‚Üí Console

JavaScript:
// Exportar todas las reglas
const auth = btoa('admin:public');

fetch('http://localhost:18083/api/v5/rules', {
  headers: {'Authorization': 'Basic ' + auth}
})
.then(r => r.json())
.then(data => {
  // Descargar como JSON
  const blob = new Blob([JSON.stringify(data.data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'emqx_rules_backup.json';
  a.click();
  console.log('Backup descargado');
});
Resultado: Archivo emqx_rules_backup.json descargado.

###############################################
5.4 Backup MongoDB
Consola:
# Backup
docker exec -it mongo-primary mongodump --db smartcampus --out /tmp/backup

# Copiar a host
docker cp mongo-primary:/tmp/backup ./backups/mongodb_$(date +%Y%m%d_%H%M%S)

# Limpiar contenedor
docker exec -it mongo-primary rm -rf /tmp/backup

Restaurar:
# Copiar al contenedor
docker cp ./backups/mongodb_20260128_153045 mongo-primary:/tmp/restore

# Restaurar
docker exec -it mongo-primary mongorestore --db smartcampus /tmp/restore/smartcampus --drop
